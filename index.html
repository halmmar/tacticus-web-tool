<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    header {
      width: calc(100% - 650px);
    }
    @media (min-width: 1280px) {
      header {
        position: fixed;
        top: 0;
        right: 0;
      }
    }
    table {
      max-width: 640px;
    }
    input[type='number']{
      width: 25pt;
    }
    .armourBox {
      width: 36pt !important
    }
    fieldset fieldset {
      display: inline-block;
    }
  </style>
    <script>
        
var getJSON = function(url, callback) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);
  xhr.responseType = 'json';
  xhr.onload = function() {
  var status = xhr.status;
  if (status === 200) {
    callback(null, xhr.response);
  } else {
    callback(status, xhr.response);
  }
  };
  xhr.send();
};

tb_chars = {};
tb_summons = {};
tb_chars_and_summons = {};
tb_gear = [];
tb_abilities_factor = [];
tb_archimatos_ability_factor = [];
tb_equipment = {};
intToRarity = ["common", "uncommon", "rare", "epic", "legendary"]

getJSON('tacticus.json',
function(err, data) {
  if (err !== null) {
    console.log('Something went wrong: ' + err);
  } else {
    tb_chars = data.characters;
    tb_summons = data.summons;
    tb_gear = data.gear;
    tb_abilities_factor = data.abilities_factor;
    tb_archimatos_ability_factor = data.archimatos_ability_factor;
    tb_equipment = data.equipment;
    tb_chars_and_summons = Object.assign(tb_chars,tb_summons)
    // updateGear(); // Hard-coded into the HTML
    document.getElementById("tacticus-version").innerHTML=data.version;
    ["eldryon-buff", "thaddeus-buff", "calgar-buff", "abaddon-buff", "aethana-buff", "aunshi-buff", "darkstrider-buff", "equipment"].forEach(function (key) {
      document.getElementById(key + "-rarity").innerHTML=document.getElementById("rarity-level").innerHTML;
    });
    addTable();
    updateEldryon(1);
    updateAbaddon(1);
    updateThaddeus(1);
    updateCalgar(1);
    updateAethana(1);
    updateAunShi(1);
    updateDarkstrider(1);
    updateTable();
  }
});

var levelToRarityInt = function(level) {
  return Math.min(Math.floor(level / 9), 4);
}

var passiveFactorActiveCharacterWithTable = function(tb_factor) {
  var level = +document.getElementById("skill-level").value;
  var rarity = +document.getElementById("rarity-level").value;
  return tb_factor[level-1] * (1 + rarity*0.2);
}

var passiveFactorCharacter = function(name) {
  switch (name) {
    case 'Bloodletter':
    case 'Bloodletter (v1.6)':
    case 'Archimatos':
      return passiveFactorActiveCharacterWithTable(tb_archimatos_ability_factor);
  }
  return passiveFactorActiveCharacterWithTable(tb_abilities_factor);
}

var updateEldryon = function(skipUpdate) {
  if (!document.getElementById("eldryon-buff-enabled").checked) {
    document.getElementById("eldryon-buff-all").innerHTML = 0;
    document.getElementById("eldryon-buff-aeldari").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("eldryon-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("eldryon-buff-rarity").value*0.2);
  document.getElementById("eldryon-buff-all").innerHTML = Math.round(tb_chars["Eldryon"].passive[0]*factor);
  document.getElementById("eldryon-buff-aeldari").innerHTML = Math.round(tb_chars["Eldryon"].passive[1]*factor);
  if (1 != skipUpdate) updateTable();
};

var updateAbaddon = function(skipUpdate) {
  if (!document.getElementById("abaddon-buff-enabled").checked) {
    document.getElementById("abaddon-buff-dmg").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("abaddon-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("abaddon-buff-rarity").value*0.2);
  document.getElementById("abaddon-buff-dmg").innerHTML = Math.round(tb_chars["Abaddon the despolier"].passive[0]*factor);
  if (1 != skipUpdate) updateTable();
};
var updateThaddeus = function(skipUpdate) {
  if (!document.getElementById("thaddeus-buff-enabled").checked) {
    document.getElementById("thaddeus-buff-dmg").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("thaddeus-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("thaddeus-buff-rarity").value*0.2);
  document.getElementById("thaddeus-buff-dmg").innerHTML = Math.round(tb_chars["Thaddeus noble"].passive[0]*factor);
  if (1 != skipUpdate) updateTable();
}
var updateCalgar = function(skipUpdate) {
  if (!document.getElementById("calgar-buff-enabled").checked) {
    document.getElementById("calgar-buff-all").innerHTML = 0;
    document.getElementById("calgar-buff-imperial").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("calgar-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("calgar-buff-rarity").value*0.2);
  document.getElementById("calgar-buff-all").innerHTML = Math.round(tb_chars["Marneus Calgar"].passive[0]*factor);
  document.getElementById("calgar-buff-imperial").innerHTML = Math.round(tb_chars["Marneus Calgar"].passive[1]*factor);
  if (1 != skipUpdate) updateTable();
}
var updateAethana = function(skipUpdate) {
  if (!document.getElementById("aethana-buff-enabled").checked) {
    document.getElementById("aethana-buff-all").innerHTML = 0;
    document.getElementById("aethana-buff-aeldari").innerHTML = 0;
    document.getElementById("aethana-buff-crit").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("aethana-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("aethana-buff-rarity").value*0.2);
  document.getElementById("aethana-buff-all").innerHTML = Math.round(tb_chars["Aethana"].passive[0]*factor);
  document.getElementById("aethana-buff-aeldari").innerHTML = Math.round(tb_chars["Aethana"].passive[1]*factor);
  document.getElementById("aethana-buff-crit").innerHTML = Math.round(tb_chars["Aethana"].passive[2]+levelToRarityInt(level));
  if (1 != skipUpdate) updateTable();
}
var updateAunShi = function(skipUpdate) {
  if (!document.getElementById("aunshi-buff-enabled").checked) {
    document.getElementById("aunshi-buff-dmg").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("aunshi-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("aunshi-buff-rarity").value*0.2);
  document.getElementById("aunshi-buff-dmg").innerHTML = Math.round(tb_chars["Aun'Shi (preview)"].passive[0]*factor);
  if (1 != skipUpdate) updateTable();
}
var updateDarkstrider = function(skipUpdate) {
  if (!document.getElementById("darkstrider-buff-enabled").checked) {
    document.getElementById("darkstrider-buff-dmg").innerHTML = 0;
    if (1 != skipUpdate) updateTable();
    return;
  }
  var level = document.getElementById("darkstrider-buff-level").value;
  var factor = tb_abilities_factor[level-1] * (1 + document.getElementById("darkstrider-buff-rarity").value*0.2);
  document.getElementById("darkstrider-buff-dmg").innerHTML = Math.round(tb_chars["Darkstrider"].passive[0]*factor);
  if (1 != skipUpdate) updateTable();
}

var updateGear = function() {
    res = "";
    tb_gear.forEach(function callback(v) {
        res += '<option value="'+v[1]+'"'+(v[1]==12 ? ' selected="selected"' : "")+'>'+v[0]+'</option>';
    });
    document.getElementById("gearlevel").innerHTML=res;
}

var characterTableEntryId = function(str) {
    return str.toLowerCase().replace(" ","");
}

var addTable = function() {
    res = '<tr><th onclick="sortTable(0)">Name</th><th onclick="sortTable(1)">HP</th><th title="Armour stat" onclick="sortTable(2)">Arm</th><th title="Damage stat" onclick="sortTable(3)">Dmg</th><th onclick="sortTable(4)">%</th><th onclick="sortTable(5)">Crit</th><th onclick="sortTable(6)">%</th><th onclick="sortTable(7)">Block</th><th title="Average damage for an attack, without passives" onclick="sortTable(8)">Avg dmg</th><th onclick="sortTable(9)">Comment</th></tr>';
    Object.keys(tb_chars).forEach(function callback(key) {
        var id = characterTableEntryId(key);
        res += '<tr id="'+id+'"><td>'+key+'</td><td id="'+id+'-health"></td><td id="'+id+'-armour"></td><td id="'+id+'-dmg"></td><td id="'+id+'-crit-chance"></td><td id="'+id+'-crit-dmg"></td><td id="'+id+'-block-chance"></td><td id="'+id+'-block"></td><td id="'+id+'-dmg-dealt"></td><td id="'+id+'-comment"></td></tr>';
    });
    document.getElementById("ch-table").innerHTML=res;
    updateTable();
}
var round2 = function(num) {
  return Math.round( num * 100 + Number.EPSILON ) / 100;
}
var calcDmgLowHigh = function(low, high, dmgFactor, aunshiBonusDmg, hits, armour, pierce, critChance, crit) {
  numRounds = aunshiBonusDmg > 0 ? 3 : 1;
  var total = 0;
  for (i=0; i<numRounds; i++) {
    var dmgLow = low+aunshiBonusDmg
    var dmgHigh = high+aunshiBonusDmg
    var perNonCrit = Math.max(dmgLow-armour, dmgLow*pierce)*0.5 + Math.max(dmgHigh-armour, dmgHigh*pierce)*0.5;
    var perCrit =  Math.max((dmgLow+crit)-armour, (dmgLow+crit)*pierce)*0.5 + Math.max((dmgHigh+crit)-armour, (dmgHigh+crit)*pierce)*0.5;
    for (n=1; n<=hits; n++) {
      var critCurHit = Math.pow(critChance, n);
      total += perCrit * critCurHit + perNonCrit * (1-critCurHit);
    };
  }
  return Math.round(dmgFactor*total) / numRounds;
}
var calcDmg = function(dmg, dmgFactor, aunshiBonusDmg, hits, armour, pierce, critChance, crit) {
  return calcDmgLowHigh(dmg*0.8, dmg*1.2, dmgFactor, aunshiBonusDmg, hits, armour, pierce, critChance, crit);
}
var updateTable = function() {
    var starlevel = document.getElementById("starlevel").value;
    var gearlevel = document.getElementById("gearlevel").value;
    var levelStatFactor = Math.pow(1.25205, gearlevel)*(1+0.1*starlevel);
    var opponentarmor = +document.getElementById("opponentarmor").value;
    var preferEqCritDmg = +document.getElementById("prefer-eq-crit-dmg").value;
    // Tyrant max debuff is 60%
    var eldryondamage = +document.getElementById("eldryon-buff-all").innerHTML;
    var eldryondamageAeldari = +document.getElementById("eldryon-buff-aeldari").innerHTML;
    var equipmentEnabled = document.getElementById("equipment-enabled").checked;
    var equipmentRarityInt = +(document.getElementById("equipment-rarity").value);
    var equipmentRarity = intToRarity[equipmentRarityInt];
    var equipmentLevel = Math.min(equipmentRarityInt*2+3, document.getElementById("equipment-level").value) - 1;
    var heavyWeaponEnabled = document.getElementById("heavy-weapon-enabled").checked;
    var charRarity = +document.getElementById("rarity-level").value;
    var passiveLevel = +document.getElementById("skill-level").value;
    var passiveLevelAsRarityInt = levelToRarityInt(passiveLevel)
    var madeContact = document.getElementById("made-contact").checked;
    var opponentIsMech = document.getElementById("opponent-is-mech").checked;
    var opponentIsPsyker = document.getElementById("opponent-is-psyker").checked;
    var opponentHasMarkerlight = document.getElementById("opponent-has-markerlight").checked;
    var opponentBeastSnagga = document.getElementById("opponent-beast-snagga").checked;
    var abaddonPassive = document.getElementById("abaddon-buff-enabled").checked;
    var abaddonBonusDmg = +document.getElementById("abaddon-buff-dmg").innerHTML;
    var thaddeusPassive = document.getElementById("thaddeus-buff-enabled").checked;
    var thaddeusBonusDmg = +document.getElementById("thaddeus-buff-dmg").innerHTML;
    var calgarBonusDmg = +document.getElementById("calgar-buff-all").innerHTML;
    var calgarBonusDmgImperial = +document.getElementById("calgar-buff-imperial").innerHTML;
    var aethanaBonusDmg = +document.getElementById("aethana-buff-all").innerHTML;
    var aethanaBonusDmgAeldar = +document.getElementById("aethana-buff-aeldari").innerHTML;
    var aethanaBonusCritChance = +document.getElementById("aethana-buff-crit").innerHTML;
    var aunshiBonusDmgRawData = +document.getElementById("aunshi-buff-dmg").innerHTML;
    var darkstriderBonusDmgRawData = +document.getElementById("darkstrider-buff-dmg").innerHTML;
    var ltgbEnabled = document.getElementById("ltgb-enabled").checked;
    
    Object.keys(tb_chars_and_summons).forEach(function callback(key) {
        var comment = "";
        entryId = characterTableEntryId(key);
        var char = tb_chars[key];
        var passiveFactor = passiveFactorCharacter(key);
        var levelStatFactorCurUnit = char.traits.includes("summon") ? passiveFactor : levelStatFactor;
        var health = char.health*levelStatFactorCurUnit;
        var armour = char.armour*levelStatFactorCurUnit;
        var dmg = char.damage*levelStatFactorCurUnit;
        var meleeHits = char.melee.hits;
        var critChance = 0;
        var critDamage = 0;
        var blockChance = 0;
        var block = 0;
        var dakka = 0;
        var buffDmg = 0;
        var dmgFactor = 1.0;
        var dmgFactorMelee = 1.0;
        var abaddonBonusDmgModifiedByFaction = (char.alliance == "Chaos" ? abaddonBonusDmg : 0)
        var eldryondamageModifiedByFaction = eldryondamage + (char.faction == "Aeldari" ? eldryondamageAeldari : 0.0);
        var calgardamageModifiedByFaction = (char.alliance == "Imperial" ? calgarBonusDmgImperial : calgarBonusDmg)
        var aethanadamageModifiedByFaction = aethanaBonusDmg + (char.faction == "Aeldari" ? aethanaBonusDmgAeldar : 0.0);
        var ltgbHits = (abaddonPassive || key=="Abaddon the despolier") ? 2 : 1;
        var aunshiBonusDmg = key.includes("Aun'Shi")  ? 0 : aunshiBonusDmgRawData;
        var darkstriderBonusDmg = (key.includes("Darkstrider") || !opponentHasMarkerlight) ? 0 : darkstriderBonusDmgRawData;
        var buffDmgRanged = 0;

        if (key != "Aethana") {
          critChance += aethanaBonusCritChance*0.01;
        }

        if (opponentHasMarkerlight && char.faction == "T'au Empire") {
          dmgFactor *= 1.15;
        }
        
        char.traits.forEach(function (trait) {
          switch (trait) {
            case "dakka":
              dakka = 2;
              comment += "dakka";
              break;
            case "beast snagga":
              if (opponentBeastSnagga) {
                dmgFactorMelee *= 1.20;
              }
              break;
            case "close combat weakness":
              if (opponentBeastSnagga) {
                dmgFactorMelee *= 0.50;
              }
              break;
            case "heavy weapon":
              if (thaddeusPassive) {
                buffDmg += thaddeusBonusDmg;
              }
              if (heavyWeaponEnabled) {
                dmgFactor *= 1.25;
                comment += "heavy weapon"
                if (key=="Maugan Ra") {
                  var mauganCritChance = (char.passive[1] + passiveLevelAsRarityInt - (passiveLevelAsRarityInt==0 ? 1 : 0)) / 100;
                  var mauganCritDamage = char.passive[0] * passiveFactor;
                  critChance += mauganCritChance;
                  critDamage += mauganCritDamage;
                }
              }
              break;
            case "bloodletter_1.6_extra_hit":
              if (opponentIsPsyker) {
                meleeHits += 1;
              }
              break;
            case "battle fatigue":
            case "diminutive":
            case "let the galaxy burn":
            case "terminator armour":
            case "resilient":
            case "flying":
            case "deep strike":
            case "living metal":
            case "mechanic":
            case "final vengeance":
            case "terrifying":
            case "act of faith":
            case "big target":
            case "infiltrate":
            case "mk x gravis":
            case "healer":
            case "suppressive fire":
            case "indirect fire":
            case "networked targeting":
            case "psyker":
            case "daemon":
            case "explodes":
            case "overwatch":
            case "contagions of nurgle":
            case "mechanical":
            case "mounted":
            case "vehicle":
            case "parry":
            case "summon":
            case "swarm":
            case "camouflage":
            case "putrid explosion":
              break;
            default:
              console.log("Unknown trait:", trait);
          }
        });

        switch (key) {
        case 'Incisus':
          var incisusFactor = 1+Math.min(0.05*gearlevel,0.3);
          health *= incisusFactor;
          armour *= incisusFactor;
          dmg *= incisusFactor;
          break;
        case 'High Marshal Helbrecht':
          comment += "TODO: Buff missing";
        case 'Roswitha':
          if (opponentIsPsyker) {
            buffDmg += passiveFactor*char.passive[0];
            comment += "psyker +" + Math.round(buffDmg);
          }
          break;
        case 'Kut skoden':
        case 'Angrax':
          if (madeContact) {
            var passiveDmg = char.passive[key=="Kut skoden" ? 0 : 2] * passiveFactor;
            buffDmg += passiveDmg;
            comment += "passive (" + Math.round(passiveDmg) + ")";
          }
          break;
        case 'Sword Brother Godswyl':
          var passiveDmg = char.passive[0] * passiveFactor;
          critDamage += passiveDmg;
          comment += "passive (crit +" + Math.round(passiveDmg) + ")";
          break;
        case 'Abaddon the despolier':
          abaddonBonusDmgModifiedByFaction = 0;
          break;
        case 'Marneus Calgar':
          calgardamageModifiedByFaction = 0;
          break;
        case 'Aethana':
          aethanadamageModifiedByFaction = 0;
          break;
        case 'Bloodletter':
        case 'Bloodletter (v1.6)':
          if (madeContact) {
            meleeHits += 1;
          }
          break;
        case 'Aleph-null':
        case 'Ancient Thoread':
        case 'Anuphet':
        case 'Archimatos':
        case "Aun'Shi":
        case "Aun'Shi (preview)":
        case 'Bellator':
        case 'Boss Gulgortz':
        case 'Brother Burchard':
        case 'Brother Jaeger':
        case 'Cadian Guardsman':
        case 'Colour Sergeant Kell':
        case 'Calandis':
        case 'Castellan creed':
        case 'Celestine':
        case 'Certus':
        case 'Commissar Yarrick':
        case 'Corrodius':
        case 'Geminae Superia':
        case 'Gibbascrapz':
        case 'Grot':
        case 'Grot Tank':
        case 'Haarken Worldclaimer':
        case 'Imospekh':
        case 'Inceptor':
        case 'Isabella':
        case 'Jain Zar':
        case 'Makhotep':
        case 'Maugan Ra':
        case 'Maladus':
        case 'Morvenn Vahl':
        case 'MV71 Sniper Drone':
        case 'Necron warrior':
        case 'Nauseous rotbone':
        case 'Pox Walkers':
        case "Re'Vas":
        case "Scarab Swarm":
        case "Scarab Swarm (v1.6)":
        case "Shield Drone":
        case "Sho'Syl":
        case 'Sibyll':
        case 'Snappawrecka':
        case 'Snotflogga':
        case 'Tanksmasha':
        case 'Thaddeus noble':
        case 'Thutmose':
        case 'Typhus':
        case 'Varro Tigurius':
        case 'Vindicta':
        case 'Volk':
          break;
        case 'Eldryon':
          eldryondamageModifiedByFaction = 0;
          break;
        case 'Darkstrider':
        case 'Pestillian':
          comment += "TODO: Buff missing";
          break;
        default:
          comment += "TODO: Add passive";
        }
        
        if (equipmentEnabled && char.equipment) {
          Object.keys(char.equipment).forEach(function equip(key) {
            var eqCount = char.equipment[key];
            var curEq = tb_equipment[key];
            var curChance = Object.keys(curEq).filter(function (chance) { return curEq[chance]["factions"].includes(char.faction); });
            if (preferEqCritDmg && key=="crit") {
              selectedChance = Math.min(...curChance);
            } else {
              selectedChance = Math.max(...curChance);
            }
            eqStats = curEq[selectedChance][equipmentRarity];
            if (key=="crit") {
              critChance += 1.0 - Math.pow((100-selectedChance)/100, eqCount);
            }
            if (key=="crit_booster") {
              critChance += (equipmentRarityInt+1)/100;
            }
            if (key=="block") {
              blockChance += 1.0 - Math.pow((100-selectedChance)/100, eqCount);
            }
            if (key=="block_booster") {
              blockChance += (equipmentRarityInt+1)/100;
            }
            Object.keys(eqStats).forEach(function (stat) {
              switch (stat) {
              case "health":
                health += eqCount*eqStats[stat][equipmentLevel];
                break;
              case "armour":
                armour += eqCount*eqStats[stat][equipmentLevel];
                break;
              case "block":
                block += eqCount*eqStats[stat][equipmentLevel];
                break;
              case "crit-dmg":
                critDamage += eqCount*eqStats[stat][equipmentLevel];
                break;
              default:
                console.log("Unknown stat in equipment:", stat);
              }
            });
          });
        }

        buffDmg += eldryondamageModifiedByFaction + calgardamageModifiedByFaction + abaddonBonusDmgModifiedByFaction + aethanadamageModifiedByFaction;
        buffDmgRanged += darkstriderBonusDmg;
       
        // Melee damage
        var meleeDmg = calcDmg(dmg+buffDmg, dmgFactor*dmgFactorMelee, aunshiBonusDmg, meleeHits, opponentarmor, char.melee.pierce, critChance, critDamage);
        var totalDmg = meleeDmg;
        switch (key) {
          case 'Boss Gulgortz':
            totalDmg += calcDmgLowHigh(passiveFactor*char.passive[0], passiveFactor*char.passive[1], dmgFactor, 0, 3, opponentarmor, char.ranged.pierce, critChance, critDamage);
            break;
        }
        if (ltgbEnabled && char.traits.includes("let the galaxy burn")) {
          var galaxyDmg = calcDmg(dmg+buffDmg, dmgFactor*dmgFactorMelee, 0, ltgbHits, opponentarmor, char.melee.pierce, critChance, critDamage);
          totalDmg += galaxyDmg * 0.5;
          // comment += "LtGB assumes hits on target"
        }
        if (char.hasOwnProperty("ranged")) {
          // Ranged damage
          var rangedDmg = calcDmg(dmg+buffDmg+buffDmgRanged, dmgFactor, aunshiBonusDmg, char.ranged.hits + dakka, opponentarmor, char.ranged.pierce, critChance, critDamage);
          switch (key) {
          case 'Volk':
            var volkDamageBuff = passiveFactor*char.passive[0];
            var volkDamage = calcDmg(dmg+buffDmg+volkDamageBuff, dmgFactor, 0, char.ranged.hits + dakka, opponentarmor, char.ranged.pierce + 0.2, critChance, critDamage);
            comment += "passive ("+Math.round(volkDamageBuff)+")";
            rangedDmg = rangedDmg*0.7 + volkDamage*0.3;
            break;
          case "Re'Vas":
            var revasPassiveDmgLow = passiveFactor*char.passive[0];
            var revasPassiveDmgHigh = passiveFactor*char.passive[1];
            var revasPassiveOverload = (opponentHasMarkerlight || opponentIsMech) ? passiveFactor*char.passive[2] : 0;
            rangedDmg += calcDmgLowHigh(revasPassiveDmgLow+revasPassiveOverload, revasPassiveDmgHigh+revasPassiveOverload, dmgFactor, 0, 3, opponentarmor, 0.35, critChance, critDamage);
            comment += "3x "+Math.round(revasPassiveDmgLow)+"-"+Math.round(revasPassiveDmgHigh)+" +" +Math.round(revasPassiveOverload);
            break;
          }
          if (ltgbEnabled && char.traits.includes("let the galaxy burn")) {
            var galaxyDmg = calcDmg(dmg+buffDmg, dmgFactor, aunshiBonusDmg, ltgbHits, opponentarmor, char.ranged.pierce, critChance, critDamage);
            rangedDmg += galaxyDmg * 0.5;
          }
          totalDmg = Math.max(totalDmg, rangedDmg);
        }

        document.getElementById(entryId+"-health").innerHTML=Math.round(health);
        document.getElementById(entryId+"-armour").innerHTML=Math.round(armour);
        document.getElementById(entryId+"-dmg").innerHTML=Math.round(dmg);
        document.getElementById(entryId+"-dmg-dealt").innerHTML=Math.round(totalDmg);
        document.getElementById(entryId+"-crit-chance").innerHTML=round2(critChance);
        document.getElementById(entryId+"-crit-dmg").innerHTML=Math.round(critDamage);
        document.getElementById(entryId+"-block-chance").innerHTML=round2(blockChance);
        document.getElementById(entryId+"-block").innerHTML=block;
        document.getElementById(entryId+"-comment").innerHTML=comment;
    });
}

function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("ch-table");
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  /* Make a loop that will continue until
  no switching has been done: */
  while (switching) {
    // Start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /* Loop through all table rows (except the
    first, which contains table headers): */
    for (i = 1; i < (rows.length - 1); i++) {
      // Start by saying there should be no switching:
      shouldSwitch = false;
      /* Get the two elements you want to compare,
      one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place,
      based on the direction, asc or desc: */
      if (dir == "asc") {
        if (1==x.innerHTML.localeCompare(y.innerHTML, undefined, {numeric: true, sensitivity: 'base'})) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (-1==x.innerHTML.localeCompare(y.innerHTML, undefined, {numeric: true, sensitivity: 'base'})) {
          // If so, mark as a switch and break the loop:
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      /* If a switch has been marked, make the switch
      and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}
    </script>
</head>
<body>
  <header>
    <fieldset>
      <legend>Character Development Level</legend>
  <select onchange="updateTable()" name="gearlevel" id="gearlevel">
    <option value="0">Stone Rank I</option>
    <option value="1">Stone Rank II</option>
    <option value="2">Stone Rank III</option>
    <option value="3">Iron Rank I</option>
    <option value="4">Iron Rank II</option>
    <option value="5">Iron Rank III</option>
    <option value="6">Bronze Rank I</option>
    <option value="7">Bronze Rank II</option>
    <option value="8">Bronze Rank III</option>
    <option value="9">Silver Rank I</option>
    <option value="10">Silver Rank II</option>
    <option value="11">Silver Rank III</option>
    <option value="12" selected="selected">Gold Rank I</option>
    <option value="13">Gold Rank II</option>
    <option value="14">Gold Rank III</option>
    <option value="15">Diamond Rank I</option>
    <option value="16">Diamond Rank II</option>
    <option value="17">Diamond Rank III</option>
  </select>

  <select onchange="updateTable()" name="rarity-level" id="rarity-level">
    <option value="0">Common</option>
    <option value="1">Uncommon</option>
    <option value="2">Rare</option>
    <option selected="selected" value="3">Epic</option>
    <option value="4">Legendary</option>
  </select>

    <select onChange="updateTable()" id="starlevel">
      <option value="1">1 gold star</option>
      <option value="2">2 gold star</option>
      <option value="3">3 gold star</option>
      <option value="4">4 gold star</option>
      <option value="5">5 gold star</option>
      <option value="6">1 red star</option>
      <option value="7">2 red star</option>  
      <option selected="selected" value="8">3 red star</option>
      <option value="9">4 red star</option>
      <option value="10">5 red star</option>
      <option value="11">1 winged star</option>
    </select>
    <label>Skill level</label>
    <input onChange="updateTable()" type="number" id="skill-level" min="1" max="50" value="35">
    <br>
    <label>Equipment</label>
    <input onChange="updateTable()" type="checkbox" id="equipment-enabled" checked></input>
    <select onchange="updateTable()" name="equipment-rarity" id="equipment-rarity">
    </select>
    <input onChange="updateTable()" type="number" id="equipment-level" min="0" max="11" value="9">
    <select onChange="updateTable()" id="prefer-eq-crit-dmg">
      <option value="0" selected>Gun</option>
      <option value="1">Knife</option>
    </select>
    <select onChange="updateTable()" id="prefer-block-chance">
      <option value="0" selected>Block %</option>
    </select>
    <select onChange="updateTable()" id="prefer-eq-armour">
      <option value="0" selected>Health</option>
    </select>
    </fieldset>
    <fieldset>
      <legend>Opponent</legend>
      <fieldset><legend>Armour</legend>
      <input class="armourBox" onChange="updateTable()" type="number" id="opponentarmor" min="0" max="3000" value="300" size="4">
      </fieldset>
      <fieldset><legend>Mech</legend>
      <input onChange="updateTable()" type="checkbox" id="opponent-is-mech"></input>
      </fieldset>
      <fieldset><legend>Psyker</legend>
      <input onChange="updateTable()" type="checkbox" id="opponent-is-psyker"></input>
      </fieldset>
      <fieldset><legend>Markerlight</legend>
      <input onChange="updateTable()" type="checkbox" id="opponent-has-markerlight"></input>
      </fieldset>
      <fieldset><legend>Big Target</legend>
      <input title="Big Target and Vehicle are prime targets for Beast Snagga" onChange="updateTable()" type="checkbox" id="opponent-beast-snagga" checked></input>
      </fieldset>
    </fieldset>
    <fieldset>
    <legend>Buffs</legend>
    <label>Eldryon</label>
    <input onChange="updateEldryon()" type="checkbox" id="eldryon-buff-enabled" checked></input>
    <select onchange="updateEldryon()" name="eldryon-buff-rarity" id="eldryon-buff-rarity">
    </select>
    <input onChange="updateEldryon()" type="number" id="eldryon-buff-level" min="0" max="50" value="35">
    +<span id="eldryon-buff-all"></span> damage [All] +<span id="eldryon-buff-aeldari"></span> damage [Aeldari]
    <br>
    <label>Abaddon</label>
    <input onChange="updateAbaddon()" type="checkbox" id="abaddon-buff-enabled"></input>
    <select onchange="updateAbaddon()" id="abaddon-buff-rarity">
    </select>
    <input onChange="updateAbaddon()" type="number" id="abaddon-buff-level" min="0" max="50" value="35">
    +<span id="abaddon-buff-dmg"></span> damage [Chaos]
    <br>
    <label>Thaddeus</label>
    <input onChange="updateThaddeus()" type="checkbox" id="thaddeus-buff-enabled"></input>
    <select onchange="updateThaddeus()" id="thaddeus-buff-rarity">
    </select>
    <input onChange="updateThaddeus()" type="number" id="thaddeus-buff-level" min="0" max="50" value="35">
    +<span id="thaddeus-buff-dmg"></span> damage [Heavy Weapon]
    <br>
    <label>Calgar</label>
    <input onChange="updateCalgar()" type="checkbox" id="calgar-buff-enabled"></input>
    <select onchange="updateCalgar()" id="calgar-buff-rarity">
    </select>
    <input onChange="updateCalgar()" type="number" id="calgar-buff-level" min="0" max="50" value="35">
    +<span id="calgar-buff-all"></span> damage [All] +<span id="calgar-buff-imperial"></span> damage [Imperial]
    <br>
    <label>Aethana</label>
    <input onChange="updateAethana()" type="checkbox" id="aethana-buff-enabled"></input>
    <select onchange="updateAethana()" id="aethana-buff-rarity">
    </select>
    <input onChange="updateAethana()" type="number" id="aethana-buff-level" min="0" max="50" value="35">
    +<span id="aethana-buff-all"></span> damage [All] +<span id="aethana-buff-aeldari"></span> damage [Aeldari], +<span id="aethana-buff-crit"></span>% crit
    <br>
    <label>Aun'Shi</label>
    <input onChange="updateAunShi()" type="checkbox" id="aunshi-buff-enabled"></input>
    <select onchange="updateAunShi()" id="aunshi-buff-rarity">
    </select>
    <input onChange="updateAunShi()" type="number" id="aunshi-buff-level" min="0" max="50" value="35">
    +<span id="aunshi-buff-dmg"></span> damage [All] (every third turn)
    <br>
    <label>Darkstrider</label>
    <input onChange="updateDarkstrider()" type="checkbox" id="darkstrider-buff-enabled"></input>
    <select onchange="updateDarkstrider()" id="darkstrider-buff-rarity">
    </select>
    <input onChange="updateDarkstrider()" type="number" id="darkstrider-buff-level" min="0" max="50" value="35">
    +<span id="darkstrider-buff-dmg"></span> damage [Ranged; Markerlight]
    </fieldset>
    <fieldset>
    <legend>Conditional</legend>
    <label>Heavy Weapon</label>
    <input title="Heavy Weapon and similar passives (Maugan Ra) are enabled" onChange="updateTable()" type="checkbox" id="heavy-weapon-enabled" checked></input>
    <label>Made Contact</label>
    <input title="Made contact with the target this turn (does not work well on bosses that you pin down or that reduce the number of hits when moving into contact)" onChange="updateTable()" type="checkbox" id="made-contact"></input>
    <label>LtGB</label>
    <input title="Let the Galaxy Burn can be disabled since it often hits allies instead of the intended target" onChange="updateTable()" type="checkbox" id="ltgb-enabled" checked></input>
    </fieldset>
    </header>

    <table id="ch-table"></table>
  <footer>
    <p>This web application was created by Rilak (MOP-06-FAX)<br>
    Based on data and formulas in <a href="https://docs.google.com/spreadsheets/d/1al2IWwvTP3QOhHtfr6P8stdlA48ED4JFrtK8wDKznrk/edit#gid=2104934925">Towen's Awesome Calculator To Infer Cool Useful Stuff -  T.A.C.T.I.C.U.S</a> <span id="tacticus-version">v???</span> (NOD-08-POD)</p>
  </footer>
</body>

</html>
